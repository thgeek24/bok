- What
- Why
- How
	- 主分片或者副本分片检索文档的步骤顺序
	  ![](https://pdai.tech/images/db/es/es-th-2-21.png)
		- 客户端向 Node 1 发送获取请求
		- 节点使用文档的 _id 来确定文档属于分片 0。分片 0 的副本分片存在于所有的三个节点上。在这种情况下，它将请求转发到 Node 2
		- Node 2 将文档返回给 Node 1，然后将文档返回给客户端
		  
		  在处理读取请求时，协调节点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡
	- 读取文档的两步查询
		- 所有的搜索系统一般都是两阶段查询，第一阶段查询到匹配的 DocID，第二阶段再查询 DocID 对应的完整文档，这种在 Elasticsearch 里被称作 query_then_fetch
		- 这里主要介绍最常用的两阶段查询
		  ![](https://pdai.tech/images/db/es/es-th-2-32.jpeg)
			- 在初始查询阶段时，查询会广播到索引中每一个分片（主分片或者）。每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列（在 2. 搜索的时候会查询 Filesystem Cache的，但是有部分数据还在 Memory Buffer，所以搜索是近实时的）
			- 每个分片返回各自优先队列中 *所有文档的 ID* 和 *排序值* 给协调节点，它合并这些值到自己的优先队列中来获取一个全局的排序后的结果列表
			- 取回阶段，协调节点辨别出哪些节点需要被取回，并向相关的分片提交多个 GET 请求。每个节点加载并丰富文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端
- How Good
- Refs
- See Also
-