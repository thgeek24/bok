- What
	- Append Only File，一种Redis持久化的机制
	- **写后日志**，即先写内存，后写日志
	  https://pdai.tech/images/db/redis/redis-x-aof-41.jpg
- Why
	- 为什么采用写后日志
		- 两方面好处
			- 避免额外的检查开销：Redis在向AOF里边记录日志的时候，并不会先对这些命令进行语法检查（如果先记日志再执行命令的话，日志中就有可能记录了错误的命令，Redis在使用日志恢复数据时，就可能出错）
			- 不会阻塞当前的写操作
		- 潜在风险
			- 如果命令执行完成，写日志之前宕机了，会丢失数据
			- 主线程写磁盘压力大，导致写盘慢，影响后续操作
- How
	- 如何实现AOF？
		- AOF日志记录Redis的每个写命令，步骤分为：命令追加（append）、文件写入（write）和文件同步（sync）
		- **append** 当AOF持久化功能打开了，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器的 aof_buf 缓冲区。
		- **write & sync** 关于何时将 aof_buf 缓冲区的内容写入AOF文件中，Redis提供了三种写回策略：
		  collapsed:: true
		  
		  | 更新项目 | 早间时间 | 优点                    | 缺点                                 |
		  |----------|----------|-------------------------|--------------------------------------|
		  | Always   | 间歇时间 | 可靠性高，数据基本不丢失 | 多个写入会有锁争抢，性能受干扰         |
		  | Everysec | 每秒时间 | 性能适中                | 容易被干扰，导致可能丢失1秒内的数据    |
		  | No       | 偶作系统控制的时间 | 性能好                 | 可能丢失未提交数据                   |
			- `Always`，同步写回：每个写命令执行完，立马同步地将日志写回磁盘
			  logseq.order-list-type:: number
			- `Everysec`，每秒写回：每个写命令执行完，只是先把日志写到AOF文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘
			  logseq.order-list-type:: number
			- `No`，操作系统控制的写回：每个写命令执行完，只是先把日志写到AOF文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘
			  logseq.order-list-type:: number
		- 三种写回策略体现的原则
			- **trade-off**，取舍，指在性能和可靠性之间做取舍
		- AOF的同步策略设计到操作系统的函数
			- `write` 和 `fsync`
			- 《Redis设计与实现》
			  
			  *“为了提高文件写入效率，在现代操作系统中，当用户调用write函数，将一些数据写入文件时，操作系统通常会将数据暂存到一个内存缓冲区里，当缓冲区的空间被填满或超过了指定时限后，才真正将缓冲区的数据写入到磁盘里。*
			  
			  *这样的操作虽然提高了效率，但也为数据写入带来了安全问题：如果计算机停机，内存缓冲区中的数据会丢失。为此，系统提供了fsync、fdatasync同步函数，可以强制操作系统立刻将缓冲区中的数据写入到硬盘里，从而确保写入数据的安全性。“*
	- [[AOF重写]]
- How Good
- Refs
- See Also